---
title: "1_paired_Wilcoxon"
output: html_document
---
```{r}
ll = '/projects/tropics/users/cquinn/R_400/'
.libPaths(c( .libPaths(), ll))
library(dplyr)
library(tidyr)
library(ggplot2)
```

TO DO
- run all subsequent/needed LMs
- retest Wilcoxon for features to keep corrections or toss
- get hourly (not 24, 1hr) csvs to apply linear regression
  

```{r}
# boxplots for ARU comparison
index_boxplot = function(df){
  df %>%
    ungroup() %>%
    select(AM, LG) %>%
    gather(ARU, value) %>%
    ggplot(aes(x = ARU, y = value)) + 
      geom_jitter(width = 0.1, alpha = 0.1) + 
      geom_boxplot(alpha = 0.4, outlier.shape = NA, notch = TRUE)
}

# corr plots
corr_plotter = function(df){
  df%>%
    ungroup() %>%
    select(where(is.numeric)) %>%
    select(contains(c("AM","LG"))) %>%
    GGally::ggpairs(aes(alpha = 0.05), progress = FALSE)
}
```



Bring in paired ARU csv
```{r}
wd = '/projects/tropics/users/cquinn/s2l/paper1-AcousticIndices/'

# read in paired ARU csv with AM site list and LG site list
paired_df = read.csv(paste0(wd,'results/paired_ARUs/colocated_ARUs-paired.csv')) %>%
  dplyr::select(SiteID, Number.of.Recordings, Paired_site) %>%
  filter(grepl('am', SiteID)) # 24 paired sites (48 ARUs)
```

Bring in paired ARU ABGQI data
```{r}
# read in all pairs and create dataframes of each paired set of predictions by overlapping time
pair_list = list()
for(pair in seq_along(paired_df$SiteID)){
  temp_row = paired_df[pair,]
  print(paste0("Pair: ",pair))
  
  #read in csvs
  am = read.csv(paste0(wd, 'results/paired_ARUs/paired_ABGQI/', temp_row$SiteID, '.csv')) %>%
    dplyr::select(Anthro, Bio, Geo, Other, Quiet, wav, mfcc) %>%
    dplyr::rename(Anthrophony = Anthro, Biophony = Bio, Geophony = Geo, Interference = Other, Quiet = Quiet, wavAM = wav) %>%
    gather(variable, value, -wavAM, -mfcc)
  lg = read.csv(paste0(wd, 'results/paired_ARUs/paired_ABGQI/', temp_row$Paired_site, '.csv')) %>%
    dplyr::select(Anthro, Bio, Geo, Other, Quiet, wav, mfcc) %>%
    dplyr::rename(Anthrophony = Anthro, Biophony = Bio, Geophony = Geo, Interference = Other, Quiet = Quiet, wavLG = wav) %>%
    gather(variable, value, -wavLG, -mfcc)

  # build dateframe
  am$site_AM = temp_row$SiteID
  am$DD = substr(am$wav, 25, 26)
  am$HH = substr(am$wav, 28, 29)
  am$mm = substr(am$wav, 31, 32)
  am$DDHHmm = paste0(am$DD, am$HH, am$mm)
  
  lg$site_LG = temp_row$Paired_site
  lg$DD = substr(lg$wav, 25, 26)
  lg$HH = substr(lg$wav, 28, 29)
  lg$mm = substr(lg$wav, 31, 32)
  lg$DDHHmm = paste0(lg$DD, lg$HH, lg$mm)
  
  pair_list[[pair]] = am %>%
    inner_join(lg, by = c('DD','HH','mm','variable','mfcc')) %>%
    dplyr::select(wavAM, mfcc, variable, value.x, value.y, DDHHmm.x, site_AM, site_LG) %>%
    dplyr::rename(wav = wavAM, melspec = mfcc, soundType = variable, DDHHmm = DDHHmm.x, AM = value.x, LG = value.y) %>%
    mutate(SiteID = pair)
  
}
pair_preds = do.call(rbind, pair_list)
```

Bring in acoustic index csvs
```{r}
pair_list = list()
for(pair in seq_along(paired_df$SiteID)){
  temp_row = paired_df[pair,]
  print(paste0("Pair: ",pair))
  
  #read in csvs
  am = read.csv(paste0(wd, 'results/paired_ARUs/paired_acoustic_indices/', temp_row$SiteID, '.csv')) %>%
    select(-YYYY, -MM, -DD, -hh, -mm, -DDhh, -hhmm) %>%
    rename(site_AM = site, wav = file) %>%
    gather(variable, value, -wav, -site_AM)
  lg = read.csv(paste0(wd, 'results/paired_ARUs/paired_acoustic_indices/', temp_row$Paired_site, '.csv')) %>%
    select(-YYYY, -MM, -DD, -hh, -mm, -DDhh, -hhmm) %>%
    rename(site_LG = site, wav = file) %>%
    gather(variable, value, -wav, -site_LG)
  
  # build dateframe
  am$DD = substr(am$wav, 25, 26)
  am$HH = substr(am$wav, 28, 29)
  am$mm = substr(am$wav, 31, 32)
  am$DDHHmm = paste0(am$DD, am$HH, am$mm)
  
  lg$DD = substr(lg$wav, 25, 26)
  lg$HH = substr(lg$wav, 28, 29)
  lg$mm = substr(lg$wav, 31, 32)
  lg$DDHHmm = paste0(lg$DD, lg$HH, lg$mm)
  
  pair_list[[pair]] = am %>%
    inner_join(lg, by = c('DD','HH','mm','variable')) %>%
    dplyr::select(wav.x, variable, value.x, value.y, DDHHmm.x, site_AM, site_LG) %>%
    dplyr::rename(wav = wav.x, acIndex = variable, DDHHmm = DDHHmm.x, AM = value.x, LG = value.y) %>%
    mutate(SiteID = pair)
  
}
pair_indices = do.call(rbind, pair_list)
```

Bring in Bird Spp richness data
```{r}
temp = pair_indices %>%
  filter(SiteID == 3 | SiteID == 5)
unique(temp$site_AM)
unique(temp$site_LG)
```


Based on below plots there are some abnormal site pairs:
- site 3 and 5 have significant errors with LG values clustering at 0 or Quiet = 1
```{r}
pair_preds = pair_preds %>%
  filter(!(SiteID == 3 | SiteID == 5))
pair_indices = pair_indices %>%
  filter(!(SiteID == 3 | SiteID == 5))
```


Start with hourly visual of pairwise boxplots for each sound type (ABGQIU plots with 24 pairs of boxes)
```{r, fig.width = 12, fig.height = 12}
#ABGQI
# Average to the 1-hr level
pair_preds$DDHH = substr(pair_preds$DDHHmm,1,4)

by_hr_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec) %>%
  group_by(SiteID, site_AM, site_LG, soundType, DDHH) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_hr_abgqi) = sub("_1*", "", colnames(by_hr_abgqi))

by_hr_abgqi %>%
  ggplot(aes(x = LG, y = AM, colour = soundType)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~SiteID) +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")


# Acoustic indices
pair_indices$DDHH = substr(pair_indices$DDHHmm,1,4)

by_hr_indices = pair_indices %>%
  select(-wav, -DDHHmm) %>%
  group_by(SiteID, site_AM, site_LG, acIndex, DDHH) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_hr_indices) = sub("_1*", "", colnames(by_hr_indices))

by_hr_indices %>%
  ggplot(aes(x = LG, y = AM, colour = SiteID)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~acIndex, scales = "free") +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")
```


Misc stats on paired deployment
```{r}
# am 22 = 426
(temp = pair_preds %>%
  select(wav, site_AM) %>% 
  group_by(site_AM) %>%
  summarise(n_min = n_distinct(wav)))
mean(temp$n_min)
sd(temp$n_min)
```


ABGQI Wilcoxon Tests: H0: are the medians of the two samples (ARUs) equal. Non parametric alternative to t-test and for ranked variables
By-minute
```{r}
# ABGQI
# Anthro: V = 2.5424e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 2.4954e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 2.3943e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 8421355918, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 2.9767e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 11856218, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# ADI: V = 40091580, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# AEI: V = 6562820, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 14406395, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 41312736, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 40702936, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 27101670, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M: V = 44178945, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 23492951, p-value = 0.6162
temp = pair_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_A: V = 21939156, p-value = 2.428e-07
temp = pair_indices %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 25654242, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 37817973, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 38725754, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 45022147, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 46520441, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

```

By-hour
```{r}
# ABGQI
# Anthro: V = 1050914, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 899214, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 738684, p-value = 8.057e-05
temp = by_hr_abgqi %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 56690, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 1223220, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 336919, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# ADI: V = 1191008, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# AEI: V = 125585, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 390057, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 1233616, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 1234206, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 863298, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M: V = 1264509, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 644966, p-value = 0.3208
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_A: V = 616676, p-value = 0.01304
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 732456, p-value = 0.0003007
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 1109232, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 1228055, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 1292515, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 1326368, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
```

By-site
- We see at this aggregation that Geophony is no longer significantly different and bio is weakly significant (alpha = 0.05)
- Overall, the magnitude of the difference between ARUs decreases with each temporal aggregation
- site plots are relatively sparse (n = 22)
```{r, fig.width=12, fig.height=12}
by_site_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, soundType) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_site_abgqi) = sub("_1*", "", colnames(by_site_abgqi))

by_site_abgqi %>%
  ggplot(aes(x = LG, y = AM)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~soundType) +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")


# ACOUSTIC INDICES
by_site_indices = pair_indices %>%
  select(-wav, -DDHHmm, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, acIndex) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_site_indices) = sub("_1*", "", colnames(by_site_indices))

by_site_indices %>%
  ggplot(aes(x = LG, y = AM)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~acIndex, scales = 'free') +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")
```

```{r}
# ABGQI
# Anthro: V = 225, p-value = 0.0006938
temp = by_site_abgqi %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 190, p-value = 0.03907
temp = by_site_abgqi %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 136, p-value = 0.7745
temp = by_site_abgqi %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 1, p-value = 9.537e-07
temp = by_site_abgqi %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 253, p-value = 4.768e-07
temp = by_site_abgqi %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 53, p-value = 0.01558
temp = by_site_indices  %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# ADI: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# AEI: V = 0, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 47, p-value = 0.008316
temp = by_site_indices  %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 204, p-value = 0.01032
temp = by_site_indices  %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M:  = 238, p-value = 6.533e-05
temp = by_site_indices  %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 106, p-value = 0.5235
temp = by_site_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# NDSI_A: V = 119, p-value = 0.8237
temp = by_site_indices  %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 151, p-value = 0.4434
temp = by_site_indices  %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 245, p-value = 1.192e-05
temp = by_site_indices  %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 250, p-value = 2.384e-06
temp = by_site_indices  %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
```

TESTING: LM of ABGQI using by-hour data
At the by-hour level non-significant Wilcoxon tests:
- NDSI

At the by-site level non-significant Wilcoxon tests:
- Geo
- NDSI
- NDSI_A
- NDSI_B

```{r}
model_list = list()
```


```{r}
# Anthrophony
temp = by_hr_abgqi %>%
  filter(soundType == 'Anthrophony') %>%
  mutate(logAM = log(AM), logLG = log(LG))
  
# check distribution
corr_plotter(temp)

mod = lm(logAM ~ logLG, data = temp)
summary(mod)
plot(mod)

# Check for normal standardized residuals 
shapiro.test(rstandard(mod))

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=logLG)) +
  geom_ribbon(aes(ymin=lwr, ymax=upr), fill='red', alpha=.3) +
  geom_line(aes(y=fit), color='red') +
  geom_point(aes(y=logAM)) 

model_list['Anthro'] = list(mod)
```

```{r}
# Biophony
temp = by_hr_abgqi %>%
  filter(soundType == 'Biophony')
corr_plotter(temp)

# transformations
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>% # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG)) # square root appears most normal and highest correlation

# check distribution
corr_plotter(temp)

mod = lm(sqrtAM ~ sqrtLG, data = temp)
summary(mod)
plot(mod)
model_list['Biophony'] = list(mod)
```

```{r}
# Quiet
temp = by_hr_abgqi %>%
  filter(soundType == 'Quiet')
corr_plotter(temp)

temp = temp %>%
  mutate(LG2 = LG^2)

mod = lm(AM ~ LG2, data = temp)
summary(mod)
plot(mod)

model_list['Quiet'] = list(mod)
```

```{r}
# Interference
temp = by_hr_abgqi %>%
  filter(soundType == 'Interference')
corr_plotter(temp)

# log correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>% # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG))
corr_plotter(temp)


mod = lm(logAM ~ logLG, data = temp)
summary(mod)
plot(mod)

model_list['Interference'] = list(mod)
```


Check whether our corrected LG data results in non-signficant Wilcoxon tests
ANTHROPHONY
```{r}
# check our model for transformations
model_list$Anthro

# create new transformed data to predict on
corrected_df = by_hr_abgqi %>%
  ungroup() %>%
  filter(soundType == 'Anthrophony') %>%
  mutate(logLG = log(LG + 0.000001)) %>%
  select(SiteID, logLG, AM, LG)

# prediction
corrected_df$y_pred = predict(model_list$Anthro, newdata = corrected_df)

# transform response (logAM) back to standard scale (0-1)
corrected_df = corrected_df %>%
  mutate(LG_corr = exp(y_pred)) %>%
  mutate(LG_corr = ifelse(LG_corr > 1, 1, LG_corr))

# HOURLY
# V = 800499, p-value = 6.106e-13
(mod = wilcox.test(corrected_df$AM, corrected_df$LG_corr, paired = TRUE))


# SITE
# V = 171, p-value = 0.156
corrected_df_site = corrected_df%>%
  group_by(SiteID) %>%
  summarise(across(everything(), list(mean))) 
colnames(corrected_df_site) = sub("*_1$", "", colnames(corrected_df_site))
(mod = wilcox.test(corrected_df_site$AM, corrected_df_site$LG_corr, paired = TRUE))

corrected_df_site %>%
  select(AM, LG_corr) %>%
  rename(LG = LG_corr) %>%
  index_boxplot()
```

BIOPHONY
```{r}
# check our model for transformations
model_list$Biophony

# create new transformed data to predict on
corrected_df = by_hr_abgqi %>%
  ungroup() %>%
  filter(soundType == 'Biophony') %>%
  mutate(sqrtLG = sqrt(LG)) %>%
  select(SiteID, sqrtLG, AM, LG)

# prediction
corrected_df$y_pred = predict(model_list$Biophony, newdata = corrected_df)

# transform back to response scale (0-1)
corrected_df = corrected_df %>%
  mutate(LG_corr = y_pred^2)

# V = 797781, p-value = 1.727e-12
(mod = wilcox.test(corrected_df$AM, corrected_df$LG_corr, paired = TRUE))

# SITE
# V = 183, p-value = 0.06844
corrected_df_site = corrected_df%>%
  group_by(SiteID) %>%
  summarise(across(everything(), list(mean))) 
colnames(corrected_df_site) = sub("*_1$", "", colnames(corrected_df_site))
(mod = wilcox.test(corrected_df_site$AM, corrected_df_site$LG_corr, paired = TRUE))

corrected_df_site %>%
  select(AM, LG_corr) %>%
  rename(LG = LG_corr) %>%
  index_boxplot()
```

QUIET
```{r}
# check our model for transformations
model_list$Quiet
summary(model_list$Quiet)

# create new transformed data to predict on
corrected_df = by_hr_abgqi %>%
  ungroup() %>%
  filter(soundType == 'Quiet') %>%
  mutate(LG2 = LG^2) %>%
  select(SiteID, LG2, AM, LG)

# prediction
corrected_df$y_pred = predict(model_list$Quiet, newdata = corrected_df)

# Quiet AM was not transformed, prediction is on standard scale
corrected_df = corrected_df %>%
  mutate(LG_corr = y_pred)

# V = 664112, p-value = 0.9876
(mod = wilcox.test(corrected_df$AM, corrected_df$LG_corr, paired = TRUE))

corrected_df %>%
  select(AM, LG_corr) %>%
  rename(LG = LG_corr) %>%
  index_boxplot()

# SITE
# V = 132, p-value = 0.8736
corrected_df_site = corrected_df%>%
  group_by(SiteID) %>%
  summarise(across(everything(), list(mean))) 
colnames(corrected_df_site) = sub("*_1$", "", colnames(corrected_df_site))
(mod = wilcox.test(corrected_df_site$AM, corrected_df_site$LG_corr, paired = TRUE))

corrected_df_site %>%
  select(AM, LG, LG_corr) %>%
  gather(variable, value) %>%
  ggplot(aes(x = variable, y = value)) +
      geom_jitter(width = 0.1, alpha = 0.3) + 
      geom_boxplot(alpha = 0.4, outlier.shape = NA, notch = TRUE) +
      labs(title = "Paired ARU corrections by-site for Quiet") +
      ylab('Percent present') +
      xlab('ARU model')
  
```

INTERFERENCE
```{r}
# check our model for transformations
model_list$Interference

# create new transformed data to predict on
corrected_df = by_hr_abgqi %>%
  ungroup() %>%
  filter(soundType == 'Interference') %>%
  mutate(logLG = log(LG)) %>%
  select(SiteID, logLG, AM, LG)

# prediction
corrected_df$y_pred = predict(model_list$Interference, newdata = corrected_df)

# transform response (logAM) back to standard scale (0-1)
corrected_df = corrected_df %>%
  mutate(LG_corr = exp(y_pred)) %>%
  mutate(LG_corr = ifelse(LG_corr > 1, 1, LG_corr))

# V = 779521, p-value = 1.106e-09
(mod = wilcox.test(corrected_df$AM, corrected_df$LG_corr, paired = TRUE))

# SITE
# V = 184, p-value = 0.06342
corrected_df_site = corrected_df%>%
  group_by(SiteID) %>%
  summarise(across(everything(), list(mean))) 
colnames(corrected_df_site) = sub("*_1$", "", colnames(corrected_df_site))
(mod = wilcox.test(corrected_df_site$AM, corrected_df_site$LG_corr, paired = TRUE))

corrected_df_site %>%
  select(AM, LG, LG_corr) %>%
  gather(variable, value) %>%
  ggplot(aes(x = variable, y = value)) +
  geom_jitter(width = 0.1, alpha = 0.1) + 
      geom_boxplot(alpha = 0.4, outlier.shape = NA, notch = TRUE)
  
```





Apply any corrections to the by-hour acoustic data
ABGQI
```{r}
# read in ABGQI by_hour
by_hr_df = read.csv(paste0(wd,'results/ABGQI_inference/averages/site_by_hour_all_ABGQI.csv'))
by_hr_df$ARU = substr(by_hr_df$site, 4,5)
lg_by_hr = by_hr_df %>%
  filter(ARU == 'lg') # select only lg sites to correct
```

```{r}
# ANTHRO CORRECTION
# check our model for transformations
model_list$Anthro

# create new transformed data to predict on
x = lg_by_hr %>%
  mutate(logLG = log(Anthropophony + 0.000001)) %>%
  select(logLG)

# prediction
lg_by_hr$anthro_pred = predict(model_list$Anthro, newdata = x)

# transform back to response scale (0-1)
lg_by_hr = lg_by_hr %>%
  mutate(anthro_corrected = exp(anthro_pred)) %>%
  mutate(anthro_corrected = ifelse(anthro_corrected > 1, 1, anthro_corrected))
```
```{r}
# BIOPHONY CORRECTION
model_list$Biophony
x = lg_by_hr %>%
  mutate(sqrtLG = sqrt(Biophony)) %>%
  select(sqrtLG)
lg_by_hr$biophony_pred = predict(model_list$Biophony, newdata = x)

# transform expo
lg_by_hr = lg_by_hr %>%
  mutate(biophony_corrected = biophony_pred^2)
```
```{r}
# QUIET CORRECTION
# check our model for transformations
model_list$Quiet

# create new transformed data to predict on
x = lg_by_hr %>%
  mutate(LG2 = Quiet^2) %>%
  select(LG2)

# prediction
lg_by_hr$quiet_pred = predict(model_list$Quiet, newdata = x)

# No transform needed
lg_by_hr = lg_by_hr %>%
  mutate(quiet_corrected = quiet_pred)

```
```{r}
# INTERFERENCE CORRECTION
# check our model for transformations
model_list$Interference

# create new transformed data to predict on
x = lg_by_hr %>%
  mutate(logLG = log(Interference + 0.000001)) %>%
  select(logLG)

# prediction
lg_by_hr$interference_pred = predict(model_list$Interference, newdata = x)

# transform back to response scale (0-1)
lg_by_hr = lg_by_hr %>%
  mutate(interference_corrected = exp(interference_pred)) %>%
  mutate(interference_corrected = ifelse(interference_corrected > 1, 1, interference_corrected))
```


```{r}
# combine out corrected lg data back into am data 
am_by_hr = by_hr_df %>%
  filter(ARU == 'am') %>% # select only lg sites to correct
  select(-Unidentified)
lg_by_hr = lg_by_hr %>%
  select(site, MM, DD, HH, anthro_corrected, biophony_corrected, Geophony, quiet_corrected, interference_corrected, n, ARU) %>%
  rename(Anthropophony = anthro_corrected, 
         Biophony = biophony_corrected, 
         Quiet = quiet_corrected, 
         Interference = interference_corrected)

# Concatenate rows
abgqi_corrected_combined_by_hr = rbind(am_by_hr, lg_by_hr)

# create site avg 
abgqi_corrected_combined_by_site = abgqi_corrected_combined_by_hr %>%
  select(-MM, -DD, -HH, -ARU, -n) %>%
  group_by(site) %>%
  summarise(across(everything(), list(mean))) 
colnames(abgqi_corrected_combined_by_site) = sub("*_1$", "", colnames(abgqi_corrected_combined_by_site))


# Save our abgqi data
write.csv(abgqi_corrected_combined_by_hr, paste0(wd, 'results/paired_ARUs/corrected_data/corrected_hourly_abgqi_31May2022.csv'), row.names = FALSE)
write.csv(abgqi_corrected_combined_by_site, paste0(wd, 'results/paired_ARUs/corrected_data/corrected_site_abgqi_31May2022.csv'), row.names = FALSE)

```





Apply any corrections to the by-hour acoustic data
```{r}
# read in acoustic index by_hour


```

