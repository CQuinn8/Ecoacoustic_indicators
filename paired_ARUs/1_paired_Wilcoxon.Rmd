---
title: "1_paired_Wilcoxon"
output: html_document
---
```{r}
ll = '/projects/tropics/users/cquinn/R_400/'
.libPaths(c( .libPaths(), ll))
library(dplyr)
library(tidyr)
library(ggplot2)

source('/projects/tropics/users/cquinn/s2l/code/paper1-AcousticIndices/utility_fxs.R')
```

TO DO



Bring in paired ARU csv
```{r}
wd = '/projects/tropics/users/cquinn/s2l/paper1-AcousticIndices/'

# read in paired ARU csv with AM site list and LG site list
paired_df = read.csv(paste0(wd,'results/paired_ARUs/colocated_ARUs-paired.csv')) %>%
  dplyr::select(SiteID, Number.of.Recordings, Paired_site) %>%
  filter(grepl('am', SiteID)) # 24 paired sites (48 ARUs)
```

Bring in paired ARU ABGQI data
```{r}
pair_preds = abgqi_pair_reader(paired_df)
```

Bring in acoustic index csvs
```{r}
pair_indices = acoustic_index_pair_reader(paired_df)
```

Bring in Bird Spp richness data
```{r}
temp = pair_indices %>%
  filter(!(SiteID == 3 | SiteID == 5))
unique(temp$site_AM)
unique(temp$site_LG)
```


Based on below plots there are some abnormal site pairs:
- site 3 and 5 have significant errors with LG values clustering at 0 or Quiet = 1
```{r}
pair_preds = pair_preds %>%
  filter(!(SiteID == 3 | SiteID == 5))
pair_indices = pair_indices %>%
  filter(!(SiteID == 3 | SiteID == 5))
```


Start with hourly visual of pairwise boxplots for each sound type (ABGQIU plots with 24 pairs of boxes)
```{r, fig.width = 12, fig.height = 12}
#ABGQI
# Average to the 1-hr level
pair_preds$DDHH = substr(pair_preds$DDHHmm,1,4)

by_hr_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec) %>%
  group_by(SiteID, site_AM, site_LG, soundType, DDHH) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_hr_abgqi) = sub("_1*", "", colnames(by_hr_abgqi))

by_hr_abgqi %>%
  ggplot(aes(x = LG, y = AM, colour = soundType)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~SiteID) +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")


# Acoustic indices
pair_indices$DDHH = substr(pair_indices$DDHHmm,1,4)

by_hr_indices = pair_indices %>%
  select(-wav, -DDHHmm) %>%
  group_by(SiteID, site_AM, site_LG, acIndex, DDHH) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_hr_indices) = sub("_1*", "", colnames(by_hr_indices))

by_hr_indices %>%
  ggplot(aes(x = LG, y = AM, colour = SiteID)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~acIndex, scales = "free") +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")
```


Misc stats on paired deployment
```{r}
# am 22 = 426
(temp = pair_preds %>%
  select(wav, site_AM) %>% 
  group_by(site_AM) %>%
  summarise(n_min = n_distinct(wav)))
mean(temp$n_min)
sd(temp$n_min)
```


ABGQI Wilcoxon Tests: H0: are the medians of the two samples (ARUs) equal. Non parametric alternative to t-test and for ranked variables
By-minute
```{r}
# ABGQI
# Anthro: V = 2.5424e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 2.4954e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 2.3943e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 8421355918, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 2.9767e+10, p-value < 2.2e-16
temp = pair_preds %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 11856218, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# ADI: V = 40091580, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# AEI: V = 6562820, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 14406395, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 41312736, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 40702936, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 27101670, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M: V = 44178945, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 23492951, p-value = 0.6162
temp = pair_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_A: V = 21939156, p-value = 2.428e-07
temp = pair_indices %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 25654242, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 37817973, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 38725754, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 45022147, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 46520441, p-value < 2.2e-16
temp = pair_indices %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

```

By-hour
```{r}
# ABGQI
# Anthro: V = 1050914, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 899214, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 738684, p-value = 8.057e-05
temp = by_hr_abgqi %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 56690, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 1223220, p-value < 2.2e-16
temp = by_hr_abgqi %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 336919, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# ADI: V = 1191008, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# AEI: V = 125585, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 390057, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 1233616, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 1234206, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 863298, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M: V = 1264509, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 644966, p-value = 0.3208
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_A: V = 616676, p-value = 0.01304
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 732456, p-value = 0.0003007
temp = by_hr_indices %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 1109232, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 1228055, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 1292515, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 1326368, p-value < 2.2e-16
temp = by_hr_indices %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
```

By-site
- We see at this aggregation that Geophony is no longer significantly different and bio is weakly significant (alpha = 0.05)
- Overall, the magnitude of the difference between ARUs decreases with each temporal aggregation
- site plots are relatively sparse (n = 22)
```{r, fig.width=12, fig.height=12}
by_site_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, soundType) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_site_abgqi) = sub("_1*", "", colnames(by_site_abgqi))

by_site_abgqi %>%
  ggplot(aes(x = LG, y = AM)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~soundType) +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")


# ACOUSTIC INDICES
by_site_indices = pair_indices %>%
  select(-wav, -DDHHmm, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, acIndex) %>%
  summarise(across(everything(), list(mean))) 
colnames(by_site_indices) = sub("_1*", "", colnames(by_site_indices))

by_site_indices %>%
  ggplot(aes(x = LG, y = AM)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~acIndex, scales = 'free') +
  theme(axis.text.x=element_blank()) +
  labs(x ="LG", 
       y = 'AM',
       title = "ARU paired predictions")
```

```{r}
# ABGQI
# Anthro: V = 225, p-value = 0.0006938
temp = by_site_abgqi %>%
  filter(soundType == 'Anthrophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Bio: V = 190, p-value = 0.03907
temp = by_site_abgqi %>%
  filter(soundType == 'Biophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Geo: V = 136, p-value = 0.7745
temp = by_site_abgqi %>%
  filter(soundType == 'Geophony')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Quiet: V = 1, p-value = 9.537e-07
temp = by_site_abgqi %>%
  filter(soundType == 'Quiet')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Int: V = 253, p-value = 4.768e-07
temp = by_site_abgqi %>%
  filter(soundType == 'Interference')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))


# ACOUSTIC INDICES
# ACI: V = 53, p-value = 0.01558
temp = by_site_indices  %>%
  filter(acIndex == 'ACI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# ADI: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'ADI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# AEI: V = 0, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'AEI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# BI: V = 47, p-value = 0.008316
temp = by_site_indices  %>%
  filter(acIndex == 'BI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# H: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'H')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Hs: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'Hs')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# Ht: V = 204, p-value = 0.01032
temp = by_site_indices  %>%
  filter(acIndex == 'Ht')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# M:  = 238, p-value = 6.533e-05
temp = by_site_indices  %>%
  filter(acIndex == 'M')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI: V = 106, p-value = 0.5235
temp = by_site_indices %>%
  filter(acIndex == 'NDSI')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
index_boxplot(df = temp)

# NDSI_A: V = 119, p-value = 0.8237
temp = by_site_indices  %>%
  filter(acIndex == 'NDSI_A')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# NDSI_B: V = 151, p-value = 0.4434
temp = by_site_indices  %>%
  filter(acIndex == 'NDSI_B')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# R: V = 245, p-value = 1.192e-05
temp = by_site_indices  %>%
  filter(acIndex == 'R')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# rugo: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'rugo')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# sfm: V = 250, p-value = 2.384e-06
temp = by_site_indices  %>%
  filter(acIndex == 'sfm')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))

# zcr_mean: V = 253, p-value = 4.768e-07
temp = by_site_indices  %>%
  filter(acIndex == 'zcr_mean')
(mod = wilcox.test(temp$AM, temp$LG, paired = TRUE))
```

TESTING: LM of ABGQI using by-hour data
At the by-hour level non-significant Wilcoxon tests:
- NDSI

At the by-site level non-significant Wilcoxon tests:
- Geo
- NDSI
- NDSI_A
- NDSI_B

