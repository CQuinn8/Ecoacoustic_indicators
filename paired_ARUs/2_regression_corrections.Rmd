---
title: "2_regression_corrections"
output: html_document
---
```{r}
ll = '/projects/tropics/users/cquinn/R_400/'
.libPaths(c( .libPaths(), ll))
library(dplyr)
library(tidyr)
library(ggplot2)

source('/projects/tropics/users/cquinn/s2l/code/paper1-AcousticIndices/utility_fxs.R')
```

TO DO:


For outlier detection:
- MAD approach: https://wis.kuleuven.be/statdatascience/robust/papers/2011/rousseeuwhubert-robuststatisticsforoutlierdetectio.pdf
- recommended z-score = 3 for large n (>80): https://arxiv.org/ftp/arxiv/papers/1406/1406.5074.pdf


TESTING: LM of ABGQI using by-hour data
At the by-hour level non-significant Wilcoxon tests:
- NDSI

At the by-site level non-significant Wilcoxon tests:
- Geo
- NDSI
- NDSI_A
- NDSI_B

0. Bring in paired ARU csv
```{r}
wd = '/projects/tropics/users/cquinn/s2l/paper1-AcousticIndices/'

# read in paired ARU csv with AM site list and LG site list
paired_df = read.csv(paste0(wd,'results/paired_ARUs/colocated_ARUs-paired.csv')) %>%
  dplyr::select(SiteID, Number.of.Recordings, Paired_site) %>%
  filter(grepl('am', SiteID)) # 24 paired sites (48 ARUs)

# Read in paired csvs
pair_preds = abgqi_pair_reader(paired_df) %>%
  filter(!(SiteID == 3 | SiteID == 5))
pair_indices = acoustic_index_pair_reader(paired_df) %>%
  filter(!(SiteID == 3 | SiteID == 5))
```

```{r}
# Derive average hourly and site values
# ABGQI
pair_preds$DDHH = substr(pair_preds$DDHHmm,1,4)
by_hr_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec) %>%
  group_by(SiteID, site_AM, site_LG, soundType, DDHH) %>%
  summarise(across(everything(), mean))

by_site_abgqi = pair_preds %>%
  select(-wav, -DDHHmm, -melspec, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, soundType) %>%
  summarise(across(everything(), mean))


# Acoustic indices
pair_indices$DDHH = substr(pair_indices$DDHHmm,1,4)
by_hr_indices = pair_indices %>%
  select(-wav, -DDHHmm) %>%
  group_by(SiteID, site_AM, site_LG, acIndex, DDHH) %>%
  summarise(across(everything(), mean))

by_site_indices = pair_indices %>%
  select(-wav, -DDHHmm, -DDHH) %>%
  group_by(SiteID, site_AM, site_LG, acIndex) %>%
  summarise(across(everything(), mean))

unique(by_site_indices$acIndex)
```


1. Establish linear, univariate models for AM ~ LG hourly acoustic features:
- ABQI
- ACI, ADI, AEI, BI, H, Hs, Ht, M, NDSI_A, NDSI_B, R, rugo, sfm, zcr_mean 

```{r}
model_list = list()
```

```{r}
# Anthrophony
temp = by_hr_abgqi %>%
  filter(soundType == 'Anthrophony') %>%
  mutate(logAM = log(AM), logLG = log(LG))


# check distribution
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG # use AM-LG difference as extreme values at the ARU may be okay but extreme differences will negatively impact the LM()
hist(diff_am_lg)
plot(temp$AM, temp$LG)
# scale values
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]


# Model transformed, outlier-removed data
mod = lm(log(AM) ~ log(LG), data = temp)
summary(mod)
plot(mod)


# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['Anthro'] = list(mod)
```


```{r}
# Biophony
temp = by_hr_abgqi %>%
  filter(soundType == 'Biophony')
corr_plotter(temp)

# transformations
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>% # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG)) # square root appears most normal and highest correlation

# Outlier analysis
diff_am_lg = temp$sqrtAM - temp$sqrtLG 
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# check distribution
corr_plotter(temp)

mod = lm(sqrt(AM) ~ sqrt(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr)^2, ymax = (upr)^2), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)^2), color = 'red') +
  geom_point(aes(y = AM))

model_list['Biophony'] = list(mod)
```

```{r}
# Quiet
temp = by_hr_abgqi %>%
  filter(soundType == 'Quiet')
temp = temp %>%
  mutate(LG2 = LG^2)

corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$AM - temp$LG2
# scale values
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# Model
mod = lm(AM ~ LG^2, data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr), ymax = (upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)), color = 'red') +
  geom_point(aes(y = AM))  

model_list['Quiet'] = list(mod)
```

```{r}
# Interference
temp = by_hr_abgqi %>%
  filter(soundType == 'Interference')
corr_plotter(temp)

# log correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>% # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG))
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
# scale values
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

mod = lm(log(AM) ~ log(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM))  

model_list['Interference'] = list(mod)
```

```{r}
# ACI
temp = by_hr_indices %>%
  filter(acIndex == 'ACI')
corr_plotter(temp)

# log correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) # log correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
# scale values
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(log(AM) ~ log(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['ACI'] = list(mod)
```

```{r}
# ADI
temp = by_hr_indices %>%
  filter(acIndex == 'ADI' )
corr_plotter(temp)

# correction
temp = temp %>%
  mutate(AM2 = AM^2, AM3 = AM^3, LG2 = LG^2, LG3 = LG^3)
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$AM3 - temp$LG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(AM^3 ~ LG, data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr)^(1/3), ymax = (upr)^(1/3)), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)^(1/3)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['ADI'] = list(mod)
```

```{r}
# AEI
temp = by_hr_indices %>%
  filter(acIndex == 'AEI' )
corr_plotter(temp)

# correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>%  # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG)) # sqrt correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$sqrtAM - temp$LG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(sqrt(AM) ~ LG, data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr)^2, ymax = (upr)^2), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)^2), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['AEI'] = list(mod)
```

```{r}
# BI
temp = by_hr_indices %>%
  filter(acIndex == 'BI' )
corr_plotter(temp)

# correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>%  # log correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG)) # sqrt correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(log(AM) ~ log(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM))

model_list['BI'] = list(mod)
```


```{r}
# H
temp = by_hr_indices %>%
  filter(acIndex == 'H' )
corr_plotter(temp)
summary(temp)

# correction
temp = temp %>%
  mutate(logitAM = toLogit(AM), logitLG = toLogit(LG))  # logit correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logitAM - temp$logitLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(toLogit(AM) ~ toLogit(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = fromLogit(lwr), ymax = fromLogit(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = fromLogit(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['H'] = list(mod)
```

```{r}
# Hs
temp = by_hr_indices %>%
  filter(acIndex == 'Hs' )
corr_plotter(temp)
summary(temp)

# correction
temp = temp %>%
  mutate(logitAM = toLogit(AM), logitLG = toLogit(LG))  # logit correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logitAM - temp$logitLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(toLogit(AM) ~ toLogit(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = fromLogit(lwr), ymax = fromLogit(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = fromLogit(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['Hs'] = list(mod)
```

```{r}
# Ht
temp = by_hr_indices %>%
  filter(acIndex == 'Ht' )
corr_plotter(temp)
summary(temp)

# correction
temp = temp %>%
  mutate(logitAM = toLogit(AM), logitLG = toLogit(LG))
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logitAM - temp$logitLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(toLogit(AM) ~ toLogit(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = fromLogit(lwr), ymax = fromLogit(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = fromLogit(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['Ht'] = list(mod)
```

```{r}
# M
temp = by_hr_indices %>%
  filter(acIndex == 'M' )
corr_plotter(temp)
summary(temp)

# correction
temp = temp %>%
  mutate(logAM = log(AM+0.0000001), logLG = log(LG+0.0000001))  # log correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
temp = temp[-outliers,]

# fit model
mod = lm(log(AM+0.0000001) ~ log(LG+0.0000001), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM)) 

model_list['Hs'] = list(mod)
```

```{r}
# NDSI_A ???
```

```{r}
# NDSI_B ???
```

```{r}
# R
temp = by_hr_indices %>%
  filter(acIndex == 'R' )
corr_plotter(temp)
summary(temp)

# correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG))  # logit correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
if(length(outliers) != 0 ){
  temp = temp[-outliers,]
}

# fit model
mod = lm(log(AM+0.0000001) ~ log(LG+0.0000001), data = temp)
summary(mod)
plot(mod)

# predictioncheck
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM))

model_list['R'] = list(mod)
```

```{r}
# rugo
temp = by_hr_indices %>%
  filter(acIndex == 'rugo' )
corr_plotter(temp)

# correction
temp = temp %>%
  mutate(logAM = log(AM), logLG = log(LG)) %>%  # logit correction
  mutate(sqrtAM = sqrt(AM), sqrtLG = sqrt(LG)) # sqrt correction
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$logAM - temp$logLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
if(length(outliers) != 0 ){
  temp = temp[-outliers,]
}

# fit model
mod = lm(log(AM+0.0000001) ~ log(LG+0.0000001), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = exp(lwr), ymax = exp(upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = exp(fit)), color = 'red') +
  geom_point(aes(y = AM))

model_list['rugo'] = list(mod)
```

```{r}
# sfm
temp = by_hr_indices %>%
  filter(acIndex == 'sfm' )
corr_plotter(temp)

# Outlier analysis
diff_am_lg = temp$AM - temp$LG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
if(length(outliers) != 0 ){
  temp = temp[-outliers,]
}

# fit model
mod = lm(AM ~ LG, data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr), ymax = (upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)), color = 'red') +
  geom_point(aes(y = AM))

model_list['sfm'] = list(mod)
```

```{r}
# zcr_mean
temp = by_hr_indices %>%
  filter(acIndex == 'zcr_mean' )
corr_plotter(temp)

temp = temp %>%
  mutate(sqrtLG = sqrt(LG))

# Outlier analysis
diff_am_lg = temp$AM - temp$sqrtLG
MAD_values = MAD_z(diff_am_lg)
outliers = which(abs(MAD_values) >= 3)
if(length(outliers) != 0 ){
  temp = temp[-outliers,]
}

# fit model
mod = lm(AM ~ sqrt(LG), data = temp)
summary(mod)
plot(mod)

# prediction check
emmeans::emmeans(mod, ~1, type = 'response')
ci = data.frame(predict(data = temp, mod, interval='confidence'))
temp = cbind(temp, ci)
ggplot(temp, aes(x=LG)) +
  geom_ribbon(aes(ymin = (lwr), ymax = (upr)), fill = 'red', alpha = .3) +
  geom_line(aes(y = (fit)), color = 'red') +
  geom_point(aes(y = AM))

model_list['zcr_mean'] = list(mod)
```


```{r}
saveRDS(model_list, file = paste0(wd, 'results/paired_ARUs/corrected_data/lm_paired_ARU_models.rds'))
```


